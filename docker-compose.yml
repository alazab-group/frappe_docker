version: "3.9"

x-frappe-defaults: &frappe_defaults
  image: alazab/frappe-ecosystem:${ERPNEXT_VERSION:-v15.63.0}
  restart: unless-stopped
  env_file: .env
  networks:
    - alazab-network
  volumes:
    - alazab-sites:/home/frappe/frappe-bench/sites
    - alazab-assets:/home/frappe/frappe-bench/sites/assets
    - /mnt/erpnext_data/repos:/home/frappe/frappe-bench/apps-custom

services:
  # ███████╗ 1. قاعدة البيانات ███████╗
  db:
    image: mariadb:10.6
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-Admin123}
      MYSQL_DATABASE: ${DB_NAME:-frappe}
    volumes:
      - alazab-db:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - alazab-network

  # ███████╗ 2. خدمات Redis ███████╗
  redis-cache:
    image: redis:6.2-alpine
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - alazab-redis-cache:/data
    networks:
      - alazab-network

  redis-queue:
    image: redis:6.2-alpine
    volumes:
      - alazab-redis-queue:/data
    networks:
      - alazab-network

  # ███████╗ 3. الخدمة الأساسية ███████╗
  backend:
    <<: *frappe_defaults
    depends_on:
      db:
        condition: service_healthy
      redis-cache:
        condition: service_started
    environment:
      - SITE_NAME=${FRAPPE_SITE_NAME_HEADER:-erp.alazab.online}
      - AUTO_MIGRATE=1
    command: bench start

  # ███████╗ 4. واجهة الويب ███████╗
  frontend:
    <<: *frappe_defaults
    ports:
      - "${HTTP_PUBLISH_PORT:-80}:8080"
    command: nginx-entrypoint.sh
    environment:
      - BACKEND=backend:8000
      - SOCKETIO=websocket:9000
      - UPSTREAM_REAL_IP_ADDRESS=${UPSTREAM_REAL_IP_ADDRESS:-0.0.0.0/0}
      - UPSTREAM_REAL_IP_HEADER=${UPSTREAM_REAL_IP_HEADER:-X-Forwarded-For}
      - PROXY_READ_TIMEOUT=${PROXY_READ_TIMEOUT:-300s}
      - CLIENT_MAX_BODY_SIZE=${CLIENT_MAX_BODY_SIZE:-100m}
    depends_on:
      - backend

  # ███████╗ 5. خدمات الخلفية ███████╗
  worker-short:
    <<: *frappe_defaults
    command: bench worker --queue short,default

  worker-long:
    <<: *frappe_defaults
    command: bench worker --queue long,default

  scheduler:
    <<: *frappe_defaults
    command: bench schedule

  # ███████╗ 6. WebSocket ███████╗
  websocket:
    <<: *frappe_defaults
    command: ["node", "/home/frappe/frappe-bench/apps/frappe/socketio.js"]

  # ███████╗ 7. النسخ الاحتياطي ███████╗
  backup:
    image: alpine
    volumes:
      - alazab-sites:/source
      - /mnt/erpnext_data/backups:/backup
    command: >
      sh -c "tar czf /backup/backup-$$(date +'%Y%m%d').tar.gz /source &&
      find /backup -name '*.tar.gz' -mtime +7 -delete"
    restart: on-failure
    depends_on:
      - backend

  # ███████╗ 8. Certbot لـ HTTPS ███████╗
  certbot:
    image: certbot/certbot
    volumes:
      - alazab-sites:/var/www/html
      - /etc/letsencrypt:/etc/letsencrypt
    command: certonly --webroot -w /var/www/html -d ${FRAPPE_SITE_NAME_HEADER:-erp.alazab.online} --email ${LETSENCRYPT_EMAIL:-admin@alazab.online} --agree-tos --non-interactive --keep-until-expiring
    depends_on:
      - frontend
    networks:
      - alazab-network

networks:
  alazab-network:
    driver: bridge
    name: alazab-network

volumes:
  alazab-sites:
  alazab-assets:
  alazab-db:
  alazab-redis-cache:
  alazab-redis-queue:
